using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using Serilog;
using Serilog.Events;
using System;
using System.IO;
using System.Net;

namespace Com.ByteAnalysis.IFacilita.Core.Api
{
    public class Program
    {
        private static IConfiguration configuration;

        public static void Main(string[] args)
        {
            var builder = new ConfigurationBuilder()
.SetBasePath(Directory.GetCurrentDirectory());


            if (File.Exists("appsettings.prod.json"))
                builder.AddJsonFile("appsettings.prod.json");
            else
                builder.AddJsonFile("appsettings.json");

            configuration = builder.Build();

<<<<<<< HEAD
            

            Log.Logger = new LoggerConfiguration()
            .MinimumLevel.Override("Microsoft", LogEventLevel.Warning)
            .Enrich.FromLogContext()
            .WriteTo.Console()
            .WriteTo.MongoDB(configuration.GetValue<string>("DatabaseSettings:BaseLog"), collectionName: "Core.API")
            .CreateLogger();

            try
            {
=======
            var host = new WebHostBuilder()
                .UseConfiguration(configuration)
                .UseWebRoot(Path.Combine(Directory.GetCurrentDirectory(), "wwwroot"))
>>>>>>> 4b5a0481cc026a3eb7fcb21e1df74e30b3116f4d


                var host = new WebHostBuilder()
                    .UseConfiguration(configuration)
                    .UseWebRoot(Path.Combine(Directory.GetCurrentDirectory(), "wwwroot"))

                    .ConfigureLogging(b =>
                    {
                        b.SetMinimumLevel(LogLevel.Error);
                        b.AddConfiguration(configuration);
                        b.AddConsole();
                    })
                    .UseKestrel();

                if (File.Exists("appsettings.prod.json"))
                    host.UseKestrel(
                        op =>
                        {
                            op.Listen(IPAddress.Parse("10.0.0.4"), 5000, opt =>
                            {
                                opt.UseHttps("ifacilita-ifacilita4c41ddd4-3eef-4344-a7ae-270c5d513550-20201117.pfx", "");
                            });
                        });
                else
                    host.UseUrls(new string[] { "http://*:5000" });

                Log.Information("Starting web host");

                host.UseStartup<Startup>()
                .UseSerilog() // <-- Add this line
                .Build()
                .Run();

            }
            catch (Exception ex)
            {
                Log.Fatal(ex, "Host terminated unexpectedly");
            }
            finally
            {
                Log.CloseAndFlush();
            }
        }

        /*public static IHostBuilder CreateHostBuilder(string[] args) =>
            Host.CreateDefaultBuilder(args)
                .ConfigureWebHostDefaults(webBuilder =>
                {
                    webBuilder.UseStartup<Startup>();
                });*/
    }
}
